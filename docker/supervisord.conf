[supervisord]
nodaemon=true
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
user=root

# =============================================================================
# Graceful Shutdown Configuration
# Supports graceful shutdown with configurable timeout periods
# =============================================================================
# When supervisord receives SIGTERM, it will stop all managed processes
# in reverse priority order (highest priority number first)

# =============================================================================
# PocketBase Backend Service
# Priority 100 - Starts first as other services depend on it
# Stops last during shutdown to ensure database is available
# =============================================================================
[program:pocketbase]
command=/app/pocketbase/pocketbase serve --http=0.0.0.0:8090 --dir=%(ENV_PB_DATA_DIR)s --migrationsDir=/app/pocketbase/pb_migrations
directory=/app/pocketbase
autostart=true
autorestart=true
# Log to console for visibility
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_backups=0
stdout_logfile_backups=0
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
user=nextjs
environment=HOME="/app",USER="nextjs"
# Start first with highest priority (lower number = higher priority)
priority=100
# Consider started after 5 seconds of running
startsecs=5
startretries=5
# Graceful shutdown: send SIGTERM, wait for graceful shutdown
stopsignal=TERM
stopwaitsecs=%(ENV_GRACEFUL_SHUTDOWN_TIMEOUT)s
# Kill with SIGKILL if SIGTERM doesn't work
killasgroup=true
stopasgroup=true

# =============================================================================
# Next.js Webapp Service
# Priority 200 - Starts after PocketBase
# =============================================================================
[program:nextjs]
command=yarn workspace @project/webapp start
directory=/app
autostart=true
autorestart=true
# Log to console for visibility
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_backups=0
stdout_logfile_backups=0
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
user=nextjs
environment=HOME="/app",USER="nextjs",NODE_ENV="production",PORT="3000",HOSTNAME="0.0.0.0",LOG_LEVEL="%(ENV_LOG_LEVEL)s"
# Start after PocketBase
priority=200
# Wait for process to stabilize
startsecs=5
startretries=3
# Graceful shutdown: send SIGTERM, wait for connections to drain
stopsignal=TERM
stopwaitsecs=15
killasgroup=true
stopasgroup=true

# =============================================================================
# Nginx Reverse Proxy
# Priority 10 - Starts first to accept connections
# Stops first during shutdown to stop accepting new connections
# =============================================================================
[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
# Log to console for visibility
stderr_logfile=/dev/stderr
stdout_logfile=/dev/stdout
stderr_logfile_backups=0
stdout_logfile_backups=0
stderr_logfile_maxbytes=0
stdout_logfile_maxbytes=0
user=root
# Nginx starts first to accept connections
priority=10
# Graceful shutdown: send SIGQUIT for graceful stop
stopsignal=QUIT
stopwaitsecs=10
killasgroup=true
stopasgroup=true

# =============================================================================
# Supervisor Control Interface
# =============================================================================
[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

